os: linux
dist: bionic

language: rust
rust:
  - stable
  - beta
  - nightly

cache:
  - cargo
  - directories:
      - binaryen/

addons:
  apt:
    packages:
      - curl
      - cmake
      - git

install:
  # Rust
  - rustup component add rustfmt
  - rustup component add clippy

  # WASM
  - curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh -s -- -f
  - test -d binaryen/.git || git clone https://github.com/WebAssembly/binaryen.git

  # frontend stuff
  - curl https://nodejs.org/dist/v14.15.0/node-v14.15.0-linux-x64.tar.xz > node.tar.xz
  - tar -xf node.tar.xz
  - export PATH=$(pwd)/node-v14.15.0-linux-x64/bin:$PATH

before_script:
  # the last working version of 'binaryen' is the 'a0c423ef501' commit
  - pushd binaryen && git checkout a0c423ef501 && cmake . && make wasm-opt && popd
  - npm --version
  - pushd www && npm install && node_modules/.bin/tsc --version && popd

script:
  - cargo fmt -- --check
  - cargo clippy --all-targets --all-features --workspace -- -Dwarnings -W clippy::nursery -W clippy::pedantic
  - cargo test --all-features --workspace
  - wasm-pack build --target no-modules --no-typescript
  - ./binaryen/bin/wasm-opt pkg/nono_bg.wasm -O3 -o pkg/nono_bg.wasm

before_deploy:
  # - git ls-files static | xargs -I{} find {} -type f | xargs eslint --ignore-pattern '*.html'
  - pushd www && node_modules/.bin/eslint static/ --ext .js --ext .ts && node_modules/.bin/tsc static/index.ts && popd
  - cp www/static/*.html www/static/{index,worker}.js pkg/
  - rm pkg/package.json

stages:
  - test
  - deploy

jobs:
  allow_failures:
    - rust: nightly

  fast_finish: true

  include:
    - stage: deploy
      rust: stable
      deploy:
        provider: pages
        strategy: git
        # otherwise I constantly get an error:
        # fatal: ambiguous argument 'HEAD': unknown revision or path not in the working tree.
        keep_history: true
        skip_cleanup: true
        local_dir: pkg
        token: $GITHUB_TOKEN
        on:
          branch: dev
